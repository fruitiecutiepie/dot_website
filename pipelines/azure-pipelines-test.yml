# pipelines/azure-pipelines-test.yml

trigger:
  branches:
    include:
      - '*'  # Triggers on push to any branch

pr:
  branches:
    include:
      - master  # Triggers on PRs targeting the 'main' branch

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  PNPM_STORE_PATH: '$(Pipeline.Workspace)/.pnpm-store'

steps:
  - template: templates/cache-pnpm.yml
    parameters:
      pnpmLockFile: 'pnpm-lock.yaml'
      storePath: '$(PNPM_STORE_PATH)'

  - task: UseNode@1
    inputs:
      version: '$(NODE_VERSION)'
    displayName: 'Install Node.js'

  - script: |
      npm install -g pnpm
    displayName: 'Install pnpm'

  - script: |
      pnpm install --store-dir $(PNPM_STORE_PATH)
    displayName: 'Install Dependencies'

  - script: |
      mkdir -p reports
    displayName: 'Create Reports Directory'
        
  - script: |
      sudo apt-get update
      sudo apt-get install -y libgbm-dev libxss1 libasound2 libnss3 xvfb
    displayName: 'Install GPU and X11 Dependencies'

  - script: |
      set -eux
      # Start Xvfb server
      /usr/bin/Xvfb :99 -screen 0 1024x768x24 &
      sleep 1

      # Ensure Xvfb is running
      ps aux | grep Xvfb --color=always | grep -v grep

      # Set display
      export DISPLAY=:99.0

      # Run tests
      pnpm build && node ./dist/test/runTest.js --no-sandbox

      # Run Jest Tests
      pnpm test:jest 

      # Kill Xvfb server
      killall Xvfb
    displayName: 'Run Tests with Xvfb and GPU Support'

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/reports/test-results.xml'
      mergeTestResults: true
      failTaskOnFailedTests: true
    displayName: 'Publish Test Results'